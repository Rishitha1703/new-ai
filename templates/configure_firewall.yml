- name: Configure firewall to allow port {{port}}
  hosts: {{target_hosts}}
  become: yes
  gather_facts: yes
  
  tasks:
    # UFW (Ubuntu/Debian)
    - name: Allow port {{port}} through UFW (Ubuntu/Debian)
      ufw:
        rule: allow
        port: '{{port}}'
        proto: tcp
      when: ansible_os_family == "Debian"
      
    - name: Enable UFW if not enabled
      ufw:
        state: enabled
      when: ansible_os_family == "Debian"
      
    # Firewalld (RHEL/CentOS)
    - name: Allow port {{port}} through firewalld (RHEL/CentOS)
      firewalld:
        port: '{{port}}/tcp'
        permanent: yes
        state: enabled
        immediate: yes
      when: ansible_os_family == "RedHat"
      
    - name: Verify firewall rule
      shell: |
        {% if ansible_os_family == "Debian" %}
        ufw status | grep {{port}}
        {% elif ansible_os_family == "RedHat" %}
        firewall-cmd --list-ports | grep {{port}}
        {% endif %}
      register: firewall_check
      changed_when: false
      
    - name: Display firewall status
      debug:
        msg: "âœ“ Port {{port}} is now open on {{ ansible_distribution }}"